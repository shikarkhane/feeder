{% extends "base.html" %}

{% block includejs %}
<script src="/static/js/image.js"></script>
{% end %}
{% block jscripts %}

var image_on_canvas = 0;

$(function() {
		var imageLoader = document.getElementById('imageLoader');
		imageLoader.addEventListener('change', handleImage, false);

		function handleImage(e){
            $('#divprogress').css('width','10%');
		    var reader = new FileReader();
		    reader.onload = function(event){
                $('#divprogress').css('width','20%');

                var canvasEl = fixCanvas(document.createElement('canvas'));
                canvasEl.setAttribute("id", "imageCanvas");
                $('#divcanvas').append(canvasEl);

                var imgEl = document.createElement('img');
                imgEl.onload = function()
                {
                    $('#divprogress').css('width','40%');
                    var ctx = canvasEl.getContext('2d');
                    ctx.drawImage(this, 0, 0, 243, 243);
        		    window.image_on_canvas = 1;
                    $('#imageLoader').remove();
                    $('#btn-upload').removeAttr('disabled');
                    $('#divprogress').css('width','50%');
                };
                imgEl.src = event.target.result;
		    }
		    reader.readAsDataURL(e.target.files[0]);     
		}
});

function setCoordinateCookie(position){
	  	$.cookie('MyLat', position.coords.latitude, { expires:getDate30MinFromNow(), path: '/'}); // Storing latitude value
		$.cookie('MyLon', position.coords.longitude, { expires:getDate30MinFromNow(), path: '/'}); // Storing longitude value
	 };
function couldntFetchPosition(msg){
		alert('Cannot upload content without gps-location!\n');
};
$(document).on('click', "#btn-upload", function() {
		var text = encodeURIComponent($('#tagline').val());
		if (text.length == 0){alert('Comments are missing!'); return;}
		if (window.image_on_canvas == 0){alert('Image is missing!'); return;}

		if (navigator.geolocation){
		    			navigator.geolocation.getCurrentPosition(setCoordinateCookie, couldntFetchPosition, {timeout:5000});
			    	}
		var lat = $.cookie('MyLat');
		var lon = $.cookie('MyLon');
		
		if (lat){
			var imgfile= dataURLtoBlob(document.getElementById('imageCanvas').toDataURL());
			var fd = new FormData();
			fd.append("image", imgfile);

            $('#divprogress').css('width','60%');

			$.ajax({
				  type: "POST",
				  url: "/new/location/" + lat + "/" + lon + "/text/"  + text + "/",
				  data: fd,
				  processData: false,
   				  contentType: false,
				}).done(function( respond ) {
                            $('#divprogress').css('width','100%');
                            $('#parentprogress').removeClass('progress-striped active');
                            $('#divprogress').removeClass('progress-bar-info').addClass('progress-bar-success');
						})
                     .fail(function(respond) {
                            alert( "Something went wrong!" );
                            $('#parentprogress').removeClass('progress-striped active');
                            $('#divprogress').removeClass('progress-bar-info').addClass('progress-bar-danger');
                    });
		}		
	});
{% end %}
{% block nav %}
{% end %}
{% block feed %}


<div class="row input-group">
	<input id="tagline" type="text" class="form-control" placeholder="You gotta see this!"/>
	<span class="input-group-btn">
		<button id="btn-upload" class="btn btn-default" type="button" disabled="true"><span class="glyphicon glyphicon-upload"></span></button>
	</span>
</div>
<div class="row input-group">
	<input type="file" id="imageLoader" class="btn btn-info" accept="image/*;capture=camera"/>
	<div id="divcanvas" class="well"></div>
</div>

<div id="parentprogress" class="progress progress-striped active">
  <div id="divprogress" class="progress-bar progress-bar-info"  role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
    <span class="sr-only">45% Complete</span>
  </div>
</div>


{% end %}



