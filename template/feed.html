{% extends "base.html" %}

{% block jscripts %}
	$(function() {
		var servername = "http://localhost:8888/";
		var stepsize = new Number(10);

		function setCoordinateCookie(position){
			  	$.cookie('MyLat', position.coords.latitude); // Storing latitude value
				$.cookie('MyLon', position.coords.longitude); // Storing longitude value
				window.location.replace(servername +  $.cookie("MyLat") + "/" +  $.cookie("MyLon") + "/from/0/");			
			 };
  
	 	function couldntFetchPosition(msg){
  				alert('Location not found!\n Allow browser to access location services and try again.' + msg );
	  		};

	  	if ($.cookie('MyLat') == null){
		  	if (navigator.geolocation){
			    	navigator.geolocation.getCurrentPosition(setCoordinateCookie, couldntFetchPosition);
			    }
		};

		function setFromPosition(){
			if (($.cookie('FromPosition') == null)||($.cookie('FromPosition') == "NaN")){
				$.cookie('FromPosition', 0, { path: '/'});
			};
		};

		function handlePageNumber(code){
			if (code == 1){ 
					setFromPosition();
					var nextposition = parseInt($.cookie('FromPosition')) + stepsize;
					$.cookie('FromPosition', nextposition, { path: '/'});
			};
			if (code == -1){ //decrement by step size
					setFromPosition();
					var nextposition = parseInt($.cookie('FromPosition')) - stepsize;
					if (nextposition < 0){
						nextposition = 0;
					}
					$.cookie('FromPosition', nextposition, { path: '/'}); 
			};
		};
	    
		$( '.x_minutes_ago' ).each(function(){
			var $span = $(this);
			var fulldate = formatDate(new Date($span.text()));
			$span.html(moment(fulldate, "YYYY-MM-DDTHH:mm:ssZ").fromNow());
		});
		
			// Callback for refresh on pull-down
			$('#hook-latest').hook({
			  reloadPage: false,
			  reloadEl: function(){
			  		handlePageNumber(-1);
			  		if ($.cookie('MyLat') == null){			  				
			    			window.location.replace(servername + "from/" + $.cookie('FromPosition') + "/");
			    		}
			    	else{
			    			window.location.replace(servername +  $.cookie("MyLat") + "/" +  $.cookie("MyLon") + "/from/" + $.cookie('FromPosition') + "/");
			    	}
			  }
			});

		   $("#btnnextpage").click(function() {
					handlePageNumber(1);
			  		if ($.cookie('MyLat') == null){			  				
			    			window.location.replace(servername + "from/" + $.cookie('FromPosition') + "/");
			    		}
			    	else{
			    			window.location.replace(servername +  $.cookie("MyLat") + "/" +  $.cookie("MyLon") + "/from/" + $.cookie('FromPosition') + "/");
			    	}
		    });

			$('.waypoint-prev').waypoint(function(direction) {
			  alert('prev');
			}, { offset: 0 });			
			$('.waypoint-next').waypoint(function(direction) {
			  alert('more');
			}, { offset: 'bottom-in-view' });
		
	});



{% end %}
{% block feed %}
<!--div id="hook-latest" class="hook" ><div class="hook-loader"><div class="hook-spinner"></div></div></div-->
		<div class="waypoint-prev" ></div>
	<div class="main-feed panel panel-default">
  	{% for c in posts %}
			<div class="main-post row-fluid panel-body">
				{% if c.content_img_url %}
					<a  href='{{ c.content_img_url }}' target="_blank">
				{% end %}		
			
				<div class="span1">
					<span><img src="{{ c.user_img_url }}" onError="this.onerror=null;this.src='/static/images/user_placeholder.png';" class="img-responsive"/></span>
					</div>
				<div class="span10">
					<span>{{ c.text }}</span>
				</div>
				<div class="span1 elapsed_time">
					<span class="x_minutes_ago badge">{{ c.created.strftime("%Y-%m-%dT%H:%M:%S.%fZ") }}</span>
				</div>
			{% if c.content_img_url %}
				</a>
			{% end %}
				
			</div>
	{% end %}
	</div>
	<div class="button">
		    <button id="btnnextpage">More!</button> 
	</div>
	<div class="waypoint-next" ></div>

{% end %}