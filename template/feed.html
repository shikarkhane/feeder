{% extends "base.html" %}

{% block includejs %}
<script src="/static/js/feed.js"></script>
{% end %}
{% block jscripts %}
	var url = window.location.pathname;
	var servername = 'http://' + $('<a>').prop('href', url).prop('hostname')  + '/';
	if (!($('<a>').prop('href', url).prop('port') == null)){
		servername = 'http://' + $('<a>').prop('href', url).prop('hostname') + ':' + $('<a>').prop('href', url).prop('port') + '/';
	}
	var default_pagesize = new Number(10);
	var pageload_utctime = moment.utc().valueOf(); 
	
	function setCoordinateCookie(position){
		  	$.cookie('MyLat', position.coords.latitude, { expires:getDate30MinFromNow(), path: '/'}); // Storing latitude value
			$.cookie('MyLon', position.coords.longitude, { expires:getDate30MinFromNow(), path: '/'}); // Storing longitude value
			$("#main-feed").empty();
			$.cookie('FromPosition', 0, { path: '/'});
			getFeedData(window.pageload_utctime, window.default_pagesize*3, $.cookie('MyLat'), $.cookie('MyLon'), 
			$.cookie('FromPosition'), $.cookie('myFilterTags'), $.cookie('mysearchradius'), $.cookie('mysortbyvotes'));
		 };
	function couldntFetchPosition(msg){
			alert('Location not found!\n Allow browser to access location services and try again.\nShowing random data!');
			getFeedData(window.pageload_utctime, window.default_pagesize*3, $.cookie('MyLat'), $.cookie('MyLon'), 
			$.cookie('FromPosition'), $.cookie('myFilterTags'), $.cookie('mysearchradius'), $.cookie('mysortbyvotes'));
	};
	
	$(function() {
			
			if (!($.cookie('FirstTimeUser'))){
				window.location.replace("/we/firsttimeuser/");
			};
			
			$.cookie('FromPosition', 0, { path: '/'});
			$.cookie('myFilterTags', '', { path: '/'});
			if (!($.cookie('mysearchradius'))){
				$.cookie('mysearchradius', 9, { path: '/'});
			}
			if (!($.cookie('mysortbyvotes'))){
				$.cookie('mysortbyvotes', 0, { path: '/'});
			}
			
			window.pageload_utctime = moment.utc().valueOf();
			
			if (!($.cookie('MyLat'))){
	  			if (navigator.geolocation){
		    			navigator.geolocation.getCurrentPosition(setCoordinateCookie, couldntFetchPosition, {timeout:5000});
			    	}
			}
			else{
				getFeedData(window.pageload_utctime, window.default_pagesize*3, $.cookie('MyLat'), $.cookie('MyLon'), 
					$.cookie('FromPosition'), $.cookie('myFilterTags'), $.cookie('mysearchradius'), $.cookie('mysortbyvotes'));
			
			};


	});

	$.fn.isOnScreen = function(){
	    
	    var win = $(window);
	    
	    var viewport = {
	        top : win.scrollTop(),
	        left : win.scrollLeft()
	    };
	    viewport.right = viewport.left + win.width();
	    viewport.bottom = viewport.top + win.height();
	    
	    var bounds = this.offset();
	    bounds.right = bounds.left + this.outerWidth();
	    bounds.bottom = bounds.top + this.outerHeight();
	    
	    return (!(viewport.right < bounds.left || viewport.left > bounds.right || viewport.bottom < bounds.top || viewport.top > bounds.bottom));
	    
	};
 	
	$(window).scroll(function(){
		if(($('#footer').isOnScreen())){  
							getFeedData(window.pageload_utctime, window.default_pagesize, $.cookie('MyLat'), $.cookie('MyLon'), 
							$.cookie('FromPosition'), $.cookie('myFilterTags'), $.cookie('mysearchradius'), $.cookie('mysortbyvotes'));
						}
	});


	$(document).on('click', "a.post-link", function() {
		var content_url = $(this).closest("div.post-bottom").siblings("div.content_link").text();
		window.open(content_url);
  		return false;
	});

	$(document).on('click', "a.post-like", function() {
		var doc_id = $(this).closest("div.main-post").attr("id");
		var jqxhr = $.get( window.servername + 'like/'+ encodeURIComponent(doc_id) +'/');
		var likecount = parseInt($(this).text(), 10) + 1;
		$(this).html('<span class="glyphicon glyphicon-thumbs-up"></span>&nbsp;' + likecount);
		$(this).prop('disabled', true);
        $(this).addClass('btn-info');
	});

    $(document).on('click', "a.placename", function() {
		var mainpost_id = $(this).closest("div.main-post");
        var coordinates = $(mainpost_id).find("div.coord").text();

        $(this).addClass('btn-success').removeClass('btn-default');
        if (mainpost_id.find("div.mapCanvas").length > 0){
                mainpost_id.find("div.mapCanvas").remove();
                $(this).addClass('btn-default').removeClass('btn-success');
                return;
            };

        insert_map(mainpost_id, coordinates);
        google.maps.event.addDomListener(window, 'resize', insert_map);
        google.maps.event.addDomListener(window, 'load', insert_map);
	});

	$(document).on('click', "#btnfiltertags", function(event){
		event.preventDefault();
		var filterstring = $('#txtfiltertags').val().replace(/\s+/g, '');
		var myencodedfiltertags = encodeURIComponent(filterstring);
		$.cookie('myFilterTags',  myencodedfiltertags, { expires: getDate30MinFromNow(), path: '/'});
		$("#main-feed").empty();
		$.cookie('FromPosition', 0, { path: '/'});
		window.pageload_utctime = moment.utc().valueOf();
		getFeedData(window.pageload_utctime, window.default_pagesize*3, $.cookie('MyLat'), $.cookie('MyLon'), 
		$.cookie('FromPosition'), $.cookie('myFilterTags'), $.cookie('mysearchradius'), $.cookie('mysortbyvotes'));


	});

	
{% end %}
{% block nav %}
	          <form class="navbar-form navbar-right" role="search">
	            <div class="form-group">
	              <input id="txtfiltertags" class="form-control tags" placeholder="filter by tags(,)" type="text">
	            </div>
	            <button id="btnfiltertags" type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search"></span></button>
	          </form>
{% end %}
{% block feed %}

	<div id="main-feed" class="main-feed panel panel-default">
	
	</div>
<div id="footer" class="breadcrumb">
<blockquote>
The worst thing one can do is not to try, to be aware of what one wants and not give in to it, to spend years in silent hurt wondering if something could have materialized - never knowing.
<small>- Jim Rohn</small>
</blockquote>
</div>

{% end %}


{% block afterjscripts %}


{% end %}