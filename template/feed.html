{% extends "base.html" %}

{% block jscripts %}
	$(function() {
		var url = window.location.pathname;
		var servername = 'http://' + $('<a>').prop('href', url).prop('hostname') + ':' + $('<a>').prop('href', url).prop('port') + '/';
		var stepsize = new Number(10);

		function setCoordinateCookie(position){
			  	$.cookie('MyLat', position.coords.latitude); // Storing latitude value
				$.cookie('MyLon', position.coords.longitude); // Storing longitude value
				window.location.replace(servername +  $.cookie("MyLat") + "/" +  $.cookie("MyLon") + "/from/0/");			
			 };
  
	 	function couldntFetchPosition(msg){
  				alert('Location not found!\n Allow browser to access location services and try again.' + msg );
	  		};

	  	if ($.cookie('MyLat') == null){
		  	if (navigator.geolocation){
			    	navigator.geolocation.getCurrentPosition(setCoordinateCookie, couldntFetchPosition);
			    }
		};

		function setFromPosition(){
			if (($.cookie('FromPosition') == null)||($.cookie('FromPosition') == "NaN")){
				$.cookie('FromPosition', 0, { path: '/'});
			};
		};

		function handlePageNumber(code){
			if (code == 1){ 
					setFromPosition();
					var nextposition = parseInt($.cookie('FromPosition')) + stepsize;
					$.cookie('FromPosition', nextposition, { path: '/'});
			};
			if (code == -1){ //decrement by step size
					setFromPosition();
					var nextposition = parseInt($.cookie('FromPosition')) - stepsize;
					if (nextposition < 0){
						nextposition = 0;
					}
					$.cookie('FromPosition', nextposition, { path: '/'}); 
			};
		};
	    
		   $("#btnnextpage").click(function() {
					handlePageNumber(1);
			  		if ($.cookie('MyLat') == null){			  				
			    			window.location.replace(servername + "from/" + $.cookie('FromPosition') + "/");
			    		}
			    	else{
			    			window.location.replace(servername +  $.cookie("MyLat") + "/" +  $.cookie("MyLon") + "/from/" + $.cookie('FromPosition') + "/");
			    	}
		    });

			$('.waypoint-next').waypoint(function(direction) {
			  	var result = $.get( servername + "from/" + $.cookie('FromPosition') + "/", function( data ) {
							var posts = $.parseJSON(data);
							$.each(posts, function(){
									if (this.content_img_url){
									$("#main-feed").append('<div class="main-post row-fluid panel-body"><a  href="'+ this.content_img_url + '" target="_blank"><div class="span1"><span><img src="' + this.user_img_url + '" class="img-responsive"/></span></div><div class="span10"><span>' + this.text + '</span></div><div class="span1 elapsed_time"><span class="x_minutes_ago badge">' + moment(formatDate(new Date(this.created)), "YYYY-MM-DDTHH:mm:ssZ").fromNow() + '</span></div></a></div>');
									}
									else{
									$("#main-feed").append('<div class="main-post row-fluid panel-body"><div class="span1"><span><img src="' + this.user_img_url + '" class="img-responsive"/></span></div><div class="span10"><span>' + this.text + '</span></div><div class="span1 elapsed_time"><span class="x_minutes_ago badge">' + moment(formatDate(new Date(this.created)), "YYYY-MM-DDTHH:mm:ssZ").fromNow() + '</span></div></div>');
									}
							    });
						});
			}, { offset: 'bottom-in-view' });		
	});



{% end %}
{% block feed %}
	<div id="main-feed" class="main-feed panel panel-default">
	</div>
	<div class="waypoint-next" ></div>

{% end %}